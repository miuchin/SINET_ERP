<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINET ERP v4.6</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50; --accent: #2980b9; --bg: #f4f7f6;
            --panel: #ffffff; --text: #333; --success: #27ae60; --danger: #c0392b;
            --warning: #e67e22; --google: #0F9D58;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); padding-bottom: 60px; }
        .container { max-width: 900px; margin: 0 auto; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; }
        .date-badge { font-size: 0.8rem; font-weight: bold; color: #7f8c8d; }

        /* MENU GRID */
        #menuSection { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .menu-btn { 
            background: white; border: none; padding: 20px 10px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: bold; color: var(--primary); transition: transform 0.1s;
        }
        .menu-btn:active { transform: scale(0.98); background: #f9f9f9; }
        .menu-btn span { font-size: 2rem; margin-bottom: 8px; }
        .btn-anal { background: linear-gradient(135deg, #fff, #f0f8ff); border: 1px solid #d6eaf8; grid-column: span 2; }

        /* SECTIONS */
        .app-section { display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); animation: slideUp 0.2s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .back-btn { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        #inpDesc { text-transform: uppercase; }

        .btn-save { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer; }
        .btn-save.update-mode { background: var(--warning); }
        
        .special-box { background: #fffbf0; padding: 10px; border: 1px dashed #f1c40f; border-radius: 6px; margin-top: 5px; display: none; }
        .shortcut-link { float: right; font-size: 0.85rem; color: var(--accent); cursor: pointer; text-decoration: underline; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th, td { padding: 8px 5px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f2f6; color: #2c3e50; font-weight: 600; }
        
        .btn-icon { border:none; background:none; cursor:pointer; font-size:1.1rem; padding: 0 5px; }
        .btn-icon:hover { transform: scale(1.2); }
        .edit-icon { color: var(--accent); }
        .del-icon { color: var(--danger); }
        .add-icon { color: var(--success); font-weight: bold; border:1px solid #ddd; border-radius:50%; width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center; background: #eafaf1; }

        /* CAT MANAGER */
        .cat-item { padding:10px; border-bottom:1px solid #eee; }
        .cat-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:bold; }
        .cat-header:hover { background-color: #f9f9f9; }
        .sub-cat-list { display:none; margin-top:10px; padding-left:20px; background:#fff; border-left:3px solid #ddd; }
        .sub-cat-item { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dotted #ccc; font-size:0.9rem; }

        /* HIGHLIGHT ANIMATION */
        @keyframes highlight { 0% { background-color: #fff; } 50% { background-color: #fff3cd; } 100% { background-color: #fff; } }
        .highlight-input { animation: highlight 1s ease; }

        .filter-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .stat-card { background: #ecf0f1; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 10px; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .stat-lbl { font-size: 0.8rem; color: #7f8c8d; }
        .sub-row { background-color: #fcfcfc; color: #555; font-size: 0.85rem; display: none; }
        .sub-row td { padding-left: 20px; border-bottom: 1px dashed #eee; }
        .cat-row { cursor: pointer; }
        .chart-box { position: relative; height: 300px; margin: 20px 0; }

        .action-toolbar { margin-top: 15px; text-align: right; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .btn-act { padding: 10px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .bg-green { background: var(--success); }
        .bg-blue { background: var(--accent); }
        .bg-dark { background: var(--primary); }
        .bg-warning { background: var(--warning); color: white; }

        @media print {
            body * { visibility: hidden; }
            .print-visible, .print-visible * { visibility: visible; }
            .print-visible { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            canvas { max-height: 400px; }
            .sub-row { display: table-row !important; } 
            .cat-row { font-weight: bold; background: #eee !important; -webkit-print-color-adjust: exact; }
            #analyticsPrintHeader { display: block !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div><h1>SINET ERP v4.6</h1></div>
        <div class="date-badge" id="currentDateDisplay"></div>
    </header>

    <div id="menuSection">
        <button class="menu-btn" onclick="app.nav('input')"><span>‚ûï</span> Novi Unos</button>
        <button class="menu-btn" onclick="app.nav('report')"><span>üìÖ</span> Izve≈°taj (Lista)</button>
        <button class="menu-btn btn-anal" onclick="app.nav('analytics')"><span>üìä</span> <b>ANALITIKA & DEVIZE</b><br><small style="font-size:0.7rem; font-weight:normal;">Tro≈°kovi, Struja, Grafikoni</small></button>
        <button class="menu-btn" onclick="app.nav('settings')"><span>‚öôÔ∏è</span> Pode≈°avanja</button>
        <button class="menu-btn" onclick="app.nav('help')"><span>‚ùì</span> Pomoƒá</button>
    </div>

    <div id="inputSection" class="app-section">
        <div class="nav-bar"><h2>Unos / Izmena</h2><button class="back-btn" onclick="app.nav('home')">Nazad</button></div>
        <input type="hidden" id="inpId">
        <div class="form-group"><label>Datum</label><input type="date" id="inpDate"></div>
        <div class="form-group">
            <label>Kategorija <span class="shortcut-link" onclick="app.nav('settings')">[Upravljanje Kat.]</span></label>
            <select id="inpCategory" onchange="app.handleCatChange()"></select>
        </div>
        <div class="form-group" id="grpSub"><label>Potkategorija</label><select id="inpSub"></select></div>
        <div id="specElec" class="special-box"><label>Struja (KW)</label><div style="display:flex; gap:10px;"><input type="number" id="inpVT" placeholder="VT"><input type="number" id="inpNT" placeholder="NT"></div></div>
        <div id="specFX" class="special-box"><label>Menjaƒçnica</label><div style="display:flex; gap:10px;"><input type="number" id="inpFxAmt" placeholder="Devize" step="0.01"><input type="number" id="inpFxRate" placeholder="Kurs" step="0.01"></div><div style="text-align:right; margin-top:5px;">= <span id="fxRes">0.00</span> RSD</div></div>
        <div class="form-group"><label>Iznos (RSD)</label><input type="number" id="inpAmount" step="0.01" placeholder="0.00"></div>
        <div class="form-group"><label>Opis</label><input type="text" id="inpDesc" placeholder="OPIS TRO≈†KA"></div>
        <button id="btnSave" class="btn-save" onclick="app.saveEntry()">Saƒçuvaj</button>
    </div>

    <div id="reportSection" class="app-section print-visible">
        <div class="nav-bar no-print"><h2>Dnevnik Tro≈°kova</h2><button class="back-btn" onclick="app.nav('home')">Nazad</button></div>
        <div class="filter-bar no-print">
            <button onclick="app.setReportRange('THIS_MONTH')" style="padding:5px;">Ovaj Mesec</button>
            <button onclick="app.setReportRange('ALL')" style="padding:5px;">Sve</button>
        </div>
        <div id="printHeader" style="display:none; text-align:center; margin-bottom:20px;"><h2>SINET ERP - Dnevnik</h2></div>
        <div id="reportContainer"></div>
        <div class="action-toolbar no-print">
            <button class="btn-act bg-green" onclick="app.downloadMD()">üíæ Export .MD</button>
            <button class="btn-act bg-dark" onclick="window.print()">üñ®Ô∏è ≈†tampaj</button>
        </div>
    </div>

    <div id="analyticsSection" class="app-section print-visible">
        <div class="nav-bar no-print"><h2>Analitika & Bilans</h2><button class="back-btn" onclick="app.nav('home')">Nazad</button></div>
        <div class="filter-bar no-print">
            <div><label>Od:</label><input type="date" id="anDateFrom"></div>
            <div><label>Do:</label><input type="date" id="anDateTo"></div>
        </div>
        <div class="no-print" style="margin-bottom:15px; display:flex; gap:5px;">
            <button onclick="app.quickFilter('month')" style="flex:1; padding:8px;">Mesec</button>
            <button onclick="app.quickFilter('year')" style="flex:1; padding:8px;">Godina</button>
            <button onclick="app.generateAnalytics()" style="flex:1; background:var(--accent); color:white; font-weight:bold; border:none; border-radius:4px;">OSVE≈ΩI</button>
        </div>
        <div id="analyticsPrintHeader" style="text-align:center; border-bottom:2px solid #333; margin-bottom:15px; display:none;"><h2>SINET ERP - Finansijski Presek</h2><p id="anPeriodLbl"></p></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="stat-card"><div class="stat-val" id="anTotal">0.00</div><div class="stat-lbl">Ukupno RSD</div></div>
            <div class="stat-card"><div class="stat-val" id="anAvg">0.00</div><div class="stat-lbl">Prosek / Dan</div></div>
        </div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
        <h3>Tro≈°kovi po Kategorijama</h3>
        <table id="analyticsTable"><thead><tr><th>Kategorija</th><th style="text-align:right">Iznos</th><th style="text-align:right">%</th></tr></thead><tbody id="analyticsBody"></tbody></table>
        <div style="margin-top:30px; border-top:2px dashed #ccc; padding-top:10px;"><h3>üí± Devizni Bilans</h3><div style="background:#e8f8f5; padding:10px; border-radius:6px; border:1px solid #a3e4d7;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><b>Ukupno kupljeno:</b> <span id="fxTotal">0.00</span> RSD</div><div id="fxTableContainer"></div></div></div>
        <div style="margin-top:20px; border-top:2px dashed #ccc; padding-top:10px;"><h3>‚ö° Energetski Bilans</h3><div style="display:flex; justify-content:space-between; background:#fffbf0; padding:10px; border-radius:6px; border:1px solid #f9e79f;"><div><b>Ukupno KW:</b> <span id="enTotalKW">0</span></div><div>VT: <span id="enVT">0</span> | NT: <span id="enNT">0</span></div></div></div>
        <div class="action-toolbar no-print"><button class="btn-act bg-dark" onclick="window.print()">üñ®Ô∏è ≈†tampaj Izve≈°taj</button></div>
    </div>

    <div id="settingsSection" class="app-section">
        <div class="nav-bar"><h2>Pode≈°avanja</h2><button class="back-btn" onclick="app.nav('home')">Nazad</button></div>
        
        <div style="background:#eaf2f8; padding:15px; border-radius:8px; border:1px solid #2980b9; margin-bottom:20px;">
            <h3 style="margin-top:0; color:#2980b9;">üìÇ Upravljanje Kategorijama</h3>
            
            <div class="form-group">
                <label>1. Nova Glavna Kategorija:</label>
                <div style="display:flex; gap:5px;"><input type="text" id="newMainCat" placeholder="Npr. TRO≈†KOVI STANA"><button class="btn-act bg-blue" onclick="app.addMainCat()">Dodaj</button></div>
            </div>
            
            <div class="form-group" id="subCatAdder">
                <label>2. Nova Potkategorija (za odabrano):</label>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <select id="targetMainCat"></select>
                    <div style="display:flex; gap:5px;"><input type="text" id="newSubCat" placeholder="Npr. Kirija"><button class="btn-act bg-blue" onclick="app.addSubCat()">Dodaj</button></div>
                </div>
            </div>
            
            <h4 style="margin-bottom:5px;">Lista Va≈°ih Kategorija:</h4>
            <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">Savet: Kliknite na <b style="color:var(--success)">[‚ûï]</b> da biste izabrali kategoriju za dodavanje potkategorija.</div>
            <div id="catListContainer" style="margin-top:5px; max-height:300px; overflow-y:auto; border:1px solid #ccc; background:white;"></div>
        </div>

        <div class="backup-area">
            <h3>‚òÅÔ∏è Cloud & Backup</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn-act bg-green" style="grid-column: span 2;" onclick="app.syncToGoogleCloud()">‚òÅÔ∏è Sinhronizuj (Google)</button>
                <button class="btn-act bg-dark" onclick="app.backupData()">‚¨áÔ∏è Backup Fajl</button>
                <button class="btn-act bg-warning" onclick="document.getElementById('fileRestore').click()">‚¨ÜÔ∏è Uƒçitaj Fajl</button>
            </div>
            <input type="file" id="fileRestore" style="display:none" onchange="app.restoreData(this)">
            <br><br>
            <button onclick="app.factoryReset()" style="width:100%; padding:15px; background:var(--danger); color:white; border:none; border-radius:6px;">‚ö†Ô∏è FABRIƒåKI RESET</button>
        </div>
    </div>
    
    <div id="helpSection" class="app-section">
         <div class="nav-bar"><h2>Pomoƒá i Priruƒçnik</h2><button class="back-btn" onclick="app.nav('home')">Nazad</button></div>
         <div class="help-content">
            <h3>1. KAKO UNETI NOVE KATEGORIJE (PRIMER STAN)?</h3>
            <p>≈Ωelite da dodate <b>"TRO≈†KOVI STANA"</b> i stavke Kirija, Struja, Infostan?</p>
            <ol>
                <li>Idite u <span>‚öôÔ∏è Pode≈°avanja</span>.</li>
                <li>U polje <b>"1. Nova Glavna Kategorija"</b> upi≈°ite: <code>TRO≈†KOVI STANA</code> i kliknite Dodaj.</li>
                <li>Sada tu kategoriju vidite u listi ispod.</li>
                <li>Pored nje kliknite na zeleno dugme <b>[‚ûï]</b>.</li>
                <li>Sistem ƒáe automatski postaviti "TRO≈†KOVI STANA" u polje iznad.</li>
                <li>Sada u polje za potkategoriju upi≈°ite <code>Kirija</code> i kliknite Dodaj.</li>
                <li>Zatim upi≈°ite <code>Struja</code> i kliknite Dodaj.</li>
                <li>Zatim upi≈°ite <code>Infostan</code> i kliknite Dodaj.</li>
            </ol>
            <p>Sve je spremno! Vratite se na Unos i koristite ih.</p>

            <h3>2. IZMENA I BRISANJE</h3>
            <ul>
                <li>U <b>Pode≈°avanjima</b>, kliknite na ime kategorije da vidite njene potkategorije.</li>
                <li>Kliknite <b>‚úé</b> da promenite ime (npr. "Kirija" u "Stanarina"). To ƒáe ispraviti i sve stare unose!</li>
                <li>Kliknite <b>‚ùå</b> da obri≈°ete kategoriju. (Ovo radi samo ako niste veƒá uneli tro≈°kove za nju).</li>
            </ul>

            <h3>3. ISPRAVKA GRE≈†KE U UNOSU</h3>
            <ul>
                <li>Ako ste pogre≈°ili iznos ili datum, idite u <span>üìÖ Izve≈°taj</span>.</li>
                <li>Pronaƒëite taj tro≈°ak i kliknite na <b>‚úé (olovku)</b>.</li>
                <li>Ispravite podatke i kliknite dugme <b>"A≈æuriraj Izmenu"</b>.</li>
            </ul>
         </div>
    </div>
</div>

<script>
    const CATEGORY_MAP = {
        "Hrana": ["Market", "Kvanta≈°", "Lidl", "Mega", "Pijaca R.", "Pijaca L.", "Pijaca F."],
        "Apoteka": ["Redovna terapija", "Participacija", "Pregled kod lekara", "Beli recept"],
        "Automobil": ["Gorivo", "Provera guma", "Pranje", "Tehniƒçki pregled", "Registracija", "Popravka", "Servis"],
        "Elektriƒçna energija": ["Raƒçun za struju"], "Telefon": ["A1", "YETTEL", "MTS", "Ostali"], "TV pretplata": ["SBB", "MTS", "Ostali"],
        "Higijena, Hemija": ["Sredstva za ƒçi≈°ƒáenje", "Liƒçna higijena", "Razno"], "Deca": ["Voƒáe i hrana", "Roƒëendan", "Bo≈æiƒá", "Nova Godina", "≈†kola", "Pribor"],
        "≈†i≈°anje": ["Mu≈°ko", "≈Ωensko"], "Liƒçni tro≈°ak": ["Odeƒáa", "Obuƒáa", "Donji ve≈°", "Ostalo"], "Pokloni": ["Poseta", "Roƒëendan", "Slava", "Sahrana"],
        "Groblje": ["Sahrana", "Daƒáa", "Pomen", "Zadu≈°nice", "Odr≈æavanje"], "Porezi": ["JB16", "NS", "Baj≈°a zemlja", "Stefan"],
        "Razni tro≈°kovi": ["Ostalo"], "Menjaƒçnica": ["Konverzija"] 
    };
    const SINET_CLOUD_CONFIG = { url: "https://script.google.com/macros/s/AKfycby8s-zLBrj9F0Bp8CGfmkYl_2itcMUNakKzPxfHjBl9r0SfIypVj4bmFu0mtIjTozJcvA/exec", api_secret: "SINET_2025_SECURE" };

    class App {
        constructor() {
            this.data = JSON.parse(localStorage.getItem('erp_v46_data')) || [];
            this.cats = JSON.parse(localStorage.getItem('erp_v46_cats')) || CATEGORY_MAP;
            this.chartInstance = null;
            this.init();
        }
        init() {
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('sr-RS');
            document.getElementById('inpDate').valueAsDate = new Date();
            this.populateCats(); this.renderSettingsCats();
            ['inpFxAmt', 'inpFxRate'].forEach(id => document.getElementById(id).addEventListener('input', () => {
                const a = parseFloat(document.getElementById('inpFxAmt').value)||0, b = parseFloat(document.getElementById('inpFxRate').value)||0;
                document.getElementById('fxRes').innerText = (a*b).toFixed(2);
            }));
        }
        nav(s) {
            document.querySelectorAll('.app-section, #menuSection').forEach(e => e.style.display = 'none');
            if(s==='home') document.getElementById('menuSection').style.display='grid';
            else { 
                document.getElementById(s+'Section').style.display='block'; 
                if(s==='input' && !document.getElementById('inpId').value) this.resetForm();
                if(s==='report') this.renderList();
                if(s==='analytics') this.quickFilter('month'); 
                if(s==='settings') this.renderSettingsCats();
            }
        }
        
        // --- CAT & SUBCAT MANAGER ---
        populateCats() {
            const s1 = document.getElementById('inpCategory'), s2 = document.getElementById('targetMainCat');
            const sel1 = s1.value, sel2 = s2.value;
            s1.innerHTML = '<option disabled selected>Izaberi...</option>'; s2.innerHTML = '';
            Object.keys(this.cats).sort().forEach(c => {
                s1.innerHTML += `<option value="${c}">${c}</option>`; s2.innerHTML += `<option value="${c}">${c}</option>`;
            });
            if(sel1 && this.cats[sel1]) s1.value = sel1; if(sel2 && this.cats[sel2]) s2.value = sel2;
        }

        renderSettingsCats() {
            const container = document.getElementById('catListContainer');
            let html = '';
            Object.keys(this.cats).sort().forEach(c => {
                const subs = this.cats[c];
                let subHtml = '';
                subs.forEach(s => {
                    subHtml += `<div class="sub-cat-item">
                        <span>- ${s}</span>
                        <div>
                            <button class="btn-icon edit-icon" onclick="app.renameSubCat('${c}', '${s}')">‚úé</button>
                            <button class="btn-icon del-icon" onclick="app.delSubCat('${c}', '${s}')">‚ùå</button>
                        </div>
                    </div>`;
                });

                html += `<div class="cat-item">
                    <div class="cat-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">
                        <span>${c} <small>‚ñº</small></span>
                        <div onclick="event.stopPropagation()">
                            <button class="btn-icon add-icon" onclick="app.selectCatForAdd('${c}')" title="Dodaj potkategoriju">‚ûï</button>
                            <button class="btn-icon edit-icon" onclick="app.renameCat('${c}')">‚úé</button>
                            <button class="btn-icon del-icon" onclick="app.delCat('${c}')">‚ùå</button>
                        </div>
                    </div>
                    <div class="sub-cat-list">${subHtml}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        selectCatForAdd(name) {
            document.getElementById('targetMainCat').value = name;
            const input = document.getElementById('newSubCat');
            input.focus();
            input.parentElement.classList.add('highlight-input');
            setTimeout(() => input.parentElement.classList.remove('highlight-input'), 1000);
        }

        addMainCat() {
            const val = document.getElementById('newMainCat').value.trim();
            if(val && !this.cats[val]) { this.cats[val] = ["Ostalo"]; this.saveCats(); document.getElementById('newMainCat').value = ''; this.populateCats(); this.renderSettingsCats(); alert("Kategorija dodata! Sada kliknite na ‚ûï pored nje da dodate potkategorije."); } 
            else { alert("Gre≈°ka u nazivu."); }
        }
        addSubCat() {
            const main = document.getElementById('targetMainCat').value, sub = document.getElementById('newSubCat').value.trim();
            if(main && sub && !this.cats[main].includes(sub)) { this.cats[main].push(sub); this.saveCats(); document.getElementById('newSubCat').value = ''; this.renderSettingsCats(); alert("Potkategorija dodata!"); } 
            else { alert("Izaberite kategoriju i upi≈°ite naziv."); }
        }

        renameCat(oldName) {
            const newName = prompt("Novi naziv za: " + oldName, oldName);
            if(newName && newName !== oldName && !this.cats[newName]) {
                this.cats[newName] = this.cats[oldName]; delete this.cats[oldName];
                this.data.forEach(x => { if(x.cat === oldName) x.cat = newName; });
                this.saveAll(); alert("Preimenovano!");
            }
        }
        delCat(name) {
            if(this.data.some(x => x.cat === name)) return alert("Ne mo≈æe se brisati jer ima tro≈°kova!");
            if(confirm("Obri≈°i kategoriju?")) { delete this.cats[name]; this.saveAll(); }
        }
        renameSubCat(cat, oldSub) {
            const newSub = prompt("Novi naziv za: " + oldSub, oldSub);
            if(newSub && newSub !== oldSub && !this.cats[cat].includes(newSub)) {
                const idx = this.cats[cat].indexOf(oldSub); this.cats[cat][idx] = newSub;
                this.data.forEach(x => { if(x.cat === cat && x.sub === oldSub) x.sub = newSub; });
                this.saveAll(); alert("Potkategorija preimenovana!");
            }
        }
        delSubCat(cat, sub) {
            if(this.data.some(x => x.cat === cat && x.sub === sub)) return alert("Ne mo≈æe se brisati jer ima tro≈°kova!");
            if(confirm("Obri≈°i potkategoriju?")) { this.cats[cat] = this.cats[cat].filter(s => s !== sub); this.saveAll(); }
        }

        saveCats() { localStorage.setItem('erp_v46_cats', JSON.stringify(this.cats)); }
        saveAll() { this.saveCats(); localStorage.setItem('erp_v46_data', JSON.stringify(this.data)); this.populateCats(); this.renderSettingsCats(); }
        
        handleCatChange() {
            const c = document.getElementById('inpCategory').value, sub = document.getElementById('inpSub');
            sub.innerHTML = ''; 
            document.getElementById('specElec').style.display = (c==='Elektriƒçna energija')?'block':'none';
            document.getElementById('specFX').style.display = (c==='Menjaƒçnica')?'block':'none';
            document.getElementById('inpAmount').disabled = (c==='Menjaƒçnica');
            if(this.cats[c]) this.cats[c].forEach(s => sub.innerHTML += `<option value="${s}">${s}</option>`);
        }

        saveEntry() {
            const idVal = document.getElementById('inpId').value;
            const entry = {
                id: idVal ? parseInt(idVal) : Date.now(),
                date: document.getElementById('inpDate').value,
                cat: document.getElementById('inpCategory').value,
                sub: document.getElementById('inpSub').value,
                amount: parseFloat(document.getElementById('inpAmount').value), 
                desc: document.getElementById('inpDesc').value.toUpperCase(),
                meta: {}
            };
            if(!entry.cat) return alert("Kategorija!");
            if(entry.cat === 'Elektriƒçna energija') entry.meta = {vt: Number(document.getElementById('inpVT').value), nt: Number(document.getElementById('inpNT').value)};
            if(entry.cat === 'Menjaƒçnica') { entry.meta = {fxAmt: document.getElementById('inpFxAmt').value, fxRate: document.getElementById('inpFxRate').value}; entry.amount = entry.meta.fxAmt * entry.meta.fxRate; }
            if(!entry.amount && entry.amount!==0) return alert("Iznos?");

            if(idVal) { const idx = this.data.findIndex(x => x.id == idVal); if(idx > -1) this.data[idx] = entry; } 
            else { this.data.push(entry); }

            this.data.sort((a,b)=>new Date(b.date)-new Date(a.date));
            localStorage.setItem('erp_v46_data', JSON.stringify(this.data));
            alert(idVal ? "A≈æurirano!" : "Saƒçuvano!"); this.resetForm(); this.nav('report');
        }

        editEntry(id) {
            const item = this.data.find(x => x.id === id); if(!item) return;
            this.nav('input');
            document.getElementById('inpId').value = item.id;
            document.getElementById('inpDate').value = item.date;
            document.getElementById('inpCategory').value = item.cat;
            this.handleCatChange();
            document.getElementById('inpSub').value = item.sub;
            document.getElementById('inpAmount').value = item.amount;
            document.getElementById('inpDesc').value = item.desc;
            if(item.meta) {
                if(item.meta.vt) { document.getElementById('inpVT').value=item.meta.vt; document.getElementById('inpNT').value=item.meta.nt; }
                if(item.meta.fxAmt) { document.getElementById('inpFxAmt').value=item.meta.fxAmt; document.getElementById('inpFxRate').value=item.meta.fxRate; }
            }
            const btn = document.getElementById('btnSave'); btn.innerText = "A≈æuriraj Izmenu"; btn.classList.add('update-mode');
        }

        delEntry(id) {
            if(confirm("Obri≈°i tro≈°ak?")) {
                this.data = this.data.filter(x => x.id !== id);
                localStorage.setItem('erp_v46_data', JSON.stringify(this.data));
                this.renderList();
            }
        }
        resetForm() { document.querySelectorAll('input').forEach(i=>i.value=''); document.getElementById('inpDate').valueAsDate=new Date(); document.getElementById('inpId').value=''; const btn = document.getElementById('btnSave'); btn.innerText="Saƒçuvaj"; btn.classList.remove('update-mode'); }

        setReportRange(type) { this.renderList(type); }
        renderList(type='ALL') {
            const c = document.getElementById('reportContainer'); const now = new Date();
            let filtered = this.data;
            if(type==='THIS_MONTH') filtered = this.data.filter(x => new Date(x.date).getMonth() === now.getMonth() && new Date(x.date).getFullYear() === now.getFullYear());
            let h = `<table><thead><tr><th>Datum</th><th>Opis</th><th style="text-align:right">Iznos</th><th class="no-print">Akcije</th></tr></thead><tbody>`;
            let sum = 0;
            filtered.forEach(r => {
                if(r.cat!=='Menjaƒçnica') sum += r.amount;
                h += `<tr><td>${new Date(r.date).toLocaleDateString('sr-RS')}</td><td><b>${r.cat}</b> / ${r.sub}<br><i>${r.desc}</i></td><td style="text-align:right">${r.amount.toLocaleString(undefined, {minimumFractionDigits:2})}</td><td class="no-print" style="text-align:right"><button class="btn-icon edit-icon" onclick="app.editEntry(${r.id})">‚úé</button><button class="btn-icon del-icon" onclick="app.delEntry(${r.id})">‚ùå</button></td></tr>`;
            });
            h += `<tr style="background:#ddd; font-weight:bold;"><td>UKUPNO</td><td></td><td style="text-align:right">${sum.toLocaleString(undefined, {minimumFractionDigits:2})}</td><td></td></tr></tbody></table>`;
            c.innerHTML = h;
        }

        quickFilter(mode) {
            const now = new Date(); const y = now.getFullYear();
            const d1 = new Date(y, mode==='year'?0:now.getMonth(), 1);
            const d2 = new Date(y, mode==='year'?11:now.getMonth()+1, 0);
            document.getElementById('anDateFrom').valueAsDate = d1; document.getElementById('anDateTo').valueAsDate = d2;
            this.generateAnalytics();
        }

        generateAnalytics() {
            const d1 = new Date(document.getElementById('anDateFrom').value), d2 = new Date(document.getElementById('anDateTo').value);
            document.getElementById('anPeriodLbl').innerText = `${d1.toLocaleDateString()} - ${d2.toLocaleDateString()}`;
            document.getElementById('analyticsPrintHeader').style.display='block';
            const subset = this.data.filter(x => { const d = new Date(x.date); return d >= d1 && d <= d2; });

            let total = 0, cats = {}, elec = {kw:0,vt:0,nt:0}, fx = {sum:0,list:[]};
            subset.forEach(x => {
                if(x.cat === 'Menjaƒçnica') { fx.sum += x.amount; fx.list.push(x); return; }
                total += x.amount;
                if(!cats[x.cat]) cats[x.cat] = {sum:0, subs:{}};
                cats[x.cat].sum += x.amount;
                if(!cats[x.cat].subs[x.sub]) cats[x.cat].subs[x.sub]=0; cats[x.cat].subs[x.sub] += x.amount;
                if(x.cat === 'Elektriƒçna energija') { elec.vt+=(x.meta?.vt||0); elec.nt+=(x.meta?.nt||0); elec.kw=elec.vt+elec.nt; }
            });

            const dayDiff = Math.max(1, Math.ceil((d2 - d1)/(1000*60*60*24)));
            document.getElementById('anTotal').innerText = total.toLocaleString(undefined,{minimumFractionDigits:2});
            document.getElementById('anAvg').innerText = (total/dayDiff).toLocaleString(undefined,{minimumFractionDigits:2});

            let tbody = '', chartL=[], chartD=[], chartC=[];
            Object.keys(cats).sort((a,b)=>cats[b].sum-cats[a].sum).forEach((c,i) => {
                const subId = `sub_${i}`;
                tbody += `<tr class="cat-row" onclick="document.getElementById('${subId}').style.display = document.getElementById('${subId}').style.display==='table-row'?'none':'table-row'"><td><b>${c}</b> <small>‚ñº</small></td><td style="text-align:right"><b>${cats[c].sum.toLocaleString(undefined,{minimumFractionDigits:2})}</b></td><td style="text-align:right">${((cats[c].sum/total)*100).toFixed(1)}%</td></tr>`;
                tbody += `<tr id="${subId}" class="sub-row"><td colspan="3">`;
                Object.keys(cats[c].subs).forEach(s => tbody += `<div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px dotted #ddd;"><span>${s}</span> <span>${cats[c].subs[s].toLocaleString(undefined,{minimumFractionDigits:2})}</span></div>`);
                tbody += `</td></tr>`;
                chartL.push(c); chartD.push(cats[c].sum); chartC.push(`hsl(${i*40},70%,50%)`);
            });
            document.getElementById('analyticsBody').innerHTML = tbody;
            document.getElementById('fxTotal').innerText = fx.sum.toLocaleString(undefined,{minimumFractionDigits:2});
            let fxHtml = `<small><i>Lista transakcija:</i></small><br>`;
            fx.list.forEach(f => fxHtml += `<div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px solid #ccc;"><span>${new Date(f.date).toLocaleDateString()}</span><span>${f.amount.toLocaleString()} RSD (${f.meta.fxAmt}‚Ç¨)</span></div>`);
            document.getElementById('fxTableContainer').innerHTML = fxHtml;
            document.getElementById('enTotalKW').innerText = elec.kw; document.getElementById('enVT').innerText = elec.vt; document.getElementById('enNT').innerText = elec.nt;
            this.renderChart(chartL, chartD, chartC);
        }

        renderChart(l, d, c) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(this.chartInstance) this.chartInstance.destroy();
            this.chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: l, datasets: [{ data: d, backgroundColor: c }] }, options: { responsive: true, maintainAspectRatio: false, layout: {padding: 20} } });
        }

        downloadMD() {
            const d = new Date().toISOString().split('T')[0];
            let md = `# SINET ERP Izve≈°taj (${d})\n\n| Datum | Kategorija | Iznos |\n|---|---|---|\n`;
            this.data.forEach(x => md += `| ${x.date} | ${x.cat} | ${x.amount.toFixed(2)} |\n`);
            this.saveFile(md, `SINET_Izvestaj_${d}.md`, 'text/markdown');
        }
        backupData() { const d = new Date().toISOString().split('T')[0]; this.saveFile(JSON.stringify({data:this.data, cats:this.cats}), `SINET_BACKUP_${d}.json`, 'application/json'); }
        saveFile(c, n, t) { const a = document.createElement('a'); a.href = URL.createObjectURL(new File([c], n, {type:t})); a.download = n; document.body.appendChild(a); a.click(); setTimeout(()=>document.body.removeChild(a), 100); }
        async syncToGoogleCloud() { if(confirm("Sinhronizacija?")) { try { await fetch(SINET_CLOUD_CONFIG.url, {method:"POST", body:JSON.stringify({api_secret:SINET_CLOUD_CONFIG.api_secret, data:this.data})}); alert("Uspeh!"); } catch(e){alert("Gre≈°ka.");} } }
        restoreData(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{const p=JSON.parse(e.target.result); this.data=p.data; this.cats=p.cats||CATEGORY_MAP; localStorage.setItem('erp_v46_data',JSON.stringify(this.data)); localStorage.setItem('erp_v46_cats',JSON.stringify(this.cats)); location.reload();}; r.readAsText(f); }
        factoryReset() { if(confirm("FABRIƒåKI RESET?")) { localStorage.clear(); location.reload(); } }
    }
    window.app = new App();
</script>
</body>
</html>
